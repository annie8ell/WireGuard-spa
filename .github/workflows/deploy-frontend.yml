name: Deploy Frontend (SWA)

on:
  workflow_dispatch:
    inputs:
      staticWebAppName:
        description: 'Static Web App name'
        required: true
      resourceGroupName:
        description: 'Resource Group name'
        required: true
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
      - '.github/workflows/deploy-frontend.yml'

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Retrieve SWA Deployment Token
        id: swa-token
        run: |
          SWA_TOKEN=$(az staticwebapp secrets list \
            --name ${{ github.event.inputs.staticWebAppName || 'wgspa-swa' }} \
            --resource-group ${{ github.event.inputs.resourceGroupName || 'wireguard-spa-rg' }} \
            --query 'properties.apiKey' -o tsv)
          
          echo "::add-mask::$SWA_TOKEN"
          echo "token=$SWA_TOKEN" >> $GITHUB_OUTPUT

      - name: Build and Deploy Static Web App
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ steps.swa-token.outputs.token }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: 'upload'
          app_location: '/frontend'
          output_location: 'dist'

      - name: Deployment Summary
        run: |
          echo "### Frontend Deployed! âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Static Web App: ${{ github.event.inputs.staticWebAppName || 'wgspa-swa' }}" >> $GITHUB_STEP_SUMMARY
