name: Provision Infrastructure and Deploy

on:
  workflow_dispatch:
    inputs:
      resourceGroupName:
        description: 'Azure Resource Group name'
        required: true
        default: 'wireguard-spa-rg'
      location:
        description: 'Azure region for resources'
        required: true
        default: 'westeurope'
      projectName:
        description: 'Project name prefix (lowercase, no spaces)'
        required: true
        default: 'wgspa'

env:
  RESOURCE_GROUP: ${{ github.event.inputs.resourceGroupName || 'wireguard-spa-rg' }}
  LOCATION: ${{ github.event.inputs.location || 'westeurope' }}
  PROJECT_NAME: ${{ github.event.inputs.projectName || 'wgspa' }}

jobs:
  provision-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Check or Create Resource Group and Validate Location
        id: check-rg
        run: |
          set -euo pipefail
          RG="${{ env.RESOURCE_GROUP }}"
          LOCATION="${{ env.LOCATION }}"

          echo "Checking whether resource group '$RG' exists..."
          EXISTS=$(az group exists --name "$RG" || true)

          if [ "$EXISTS" = "false" ]; then
            echo "Resource group '$RG' does not exist. Creating in location '$LOCATION'..."
            az group create --name "$RG" --location "$LOCATION"
          else
            CURRENT_LOC=$(az group show --name "$RG" --query location -o tsv || true)
            if [ -z "$CURRENT_LOC" ]; then
              echo "ERROR: Unable to determine existing resource group's location for '$RG'." >&2
              exit 1
            fi

            # Normalize to lowercase for comparison
            if [ "$(echo "$CURRENT_LOC" | tr '[:upper:]' '[:lower:]')" != "$(echo "$LOCATION" | tr '[:upper:]' '[:lower:]')" ]; then
              echo "ERROR: Resource group '$RG' already exists in location '$CURRENT_LOC' but workflow requested '$LOCATION'." >&2
              echo "To continue, either choose the matching location or use a different resource group name." >&2
              exit 1
            fi

            echo "Resource group '$RG' exists in the requested location '$LOCATION'. Continuing."
          fi

      - name: Register Required Azure Resource Providers
        run: |
          set -euo pipefail
          echo "Registering required Azure resource providers..."
          
          # Register Microsoft.Insights for Application Insights
          echo "Registering Microsoft.Insights..."
          az provider register --namespace Microsoft.Insights --wait
          
          # Register Microsoft.OperationalInsights for Application Insights workspace dependencies
          echo "Registering Microsoft.OperationalInsights..."
          az provider register --namespace Microsoft.OperationalInsights --wait
          
          # Register Microsoft.Web for Function Apps and Static Web Apps
          echo "Registering Microsoft.Web..."
          az provider register --namespace Microsoft.Web --wait
          
          # Register Microsoft.Storage for Storage Accounts
          echo "Registering Microsoft.Storage..."
          az provider register --namespace Microsoft.Storage --wait
          
          echo "All required resource providers registered successfully."

      - name: Deploy Bicep Infrastructure (assumes RG exists)
        id: deploy-infra
        run: |
          set -euo pipefail
          # Bicep templates should not create the resource group (deploy into existing RG)
          
          # Attempt deployment and capture result
          if ! OUTPUT=$(az deployment group create \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --template-file infra/main.bicep \
            --parameters projectName=${{ env.PROJECT_NAME }} location=${{ env.LOCATION }} \
            --query 'properties.outputs' -o json 2>&1); then
            
            echo "ERROR: Bicep deployment failed!" >&2
            echo "Error details:" >&2
            echo "$OUTPUT" >&2
            
            echo "" >&2
            echo "Retrieving deployment operation details for diagnostics..." >&2
            
            # Get the most recent deployment name
            DEPLOYMENT_NAME=$(az deployment group list \
              --resource-group "${{ env.RESOURCE_GROUP }}" \
              --query '[0].name' -o tsv 2>/dev/null || echo "main")
            
            echo "Deployment name: $DEPLOYMENT_NAME" >&2
            
            # Show detailed deployment operations
            echo "" >&2
            echo "=== Deployment Operations ===" >&2
            az deployment operation group list \
              --resource-group "${{ env.RESOURCE_GROUP }}" \
              --name "$DEPLOYMENT_NAME" \
              --query '[?properties.provisioningState==`Failed`].[properties.targetResource.resourceType, properties.targetResource.resourceName, properties.statusMessage.error.code, properties.statusMessage.error.message]' \
              -o table 2>&1 || echo "Could not retrieve deployment operations." >&2
            
            exit 1
          fi

          echo "Deployment outputs: $OUTPUT"

          FUNCTION_APP_NAME=$(echo "$OUTPUT" | jq -r '.functionAppName.value // empty')
          SWA_NAME=$(echo "$OUTPUT" | jq -r '.staticWebAppName.value // empty')
          SWA_RESOURCE_ID=$(echo "$OUTPUT" | jq -r '.staticWebAppResourceId.value // empty')

          if [ -z "$FUNCTION_APP_NAME" ] || [ -z "$SWA_NAME" ]; then
            echo "ERROR: Expected deployment outputs not found. Check infra/main.bicep outputs." >&2
            exit 1
          fi

          echo "functionAppName=$FUNCTION_APP_NAME" >> $GITHUB_OUTPUT
          echo "staticWebAppName=$SWA_NAME" >> $GITHUB_OUTPUT
          echo "staticWebAppResourceId=$SWA_RESOURCE_ID" >> $GITHUB_OUTPUT

      - name: Retrieve SWA Deployment Token
        id: swa-token
        run: |
          set -euo pipefail
          SWA_NAME="${{ steps.deploy-infra.outputs.staticWebAppName }}"
          if [ -z "$SWA_NAME" ]; then
            echo "ERROR: Static Web App name missing from previous step outputs." >&2
            exit 1
          fi
          SWA_TOKEN=$(az staticwebapp secrets list \
            --name "$SWA_NAME" \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --query 'properties.apiKey' -o tsv)
          echo "::add-mask::$SWA_TOKEN"
          echo "token=$SWA_TOKEN" >> $GITHUB_OUTPUT

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Backend Dependencies and Create Zip
        run: |
          set -euo pipefail
          cd backend
          python -m pip install --upgrade pip
          pip install -r requirements.txt --target .python_packages/lib/site-packages
          zip -r ../backend.zip . -x "*.pyc" "__pycache__/*" "venv/*" ".venv/*" "*/.git/*"

      - name: Deploy Azure Functions via Zip Deploy
        run: |
          set -euo pipefail
          az functionapp deployment source config-zip \
            -g "${{ env.RESOURCE_GROUP }}" \
            -n "${{ steps.deploy-infra.outputs.functionAppName }}" \
            --src backend.zip

      - name: Configure Function App Settings
        run: |
          set -euo pipefail
          SUBSCRIPTION_ID=$(az account show --query id -o tsv)
          az functionapp config appsettings set \
            --name "${{ steps.deploy-infra.outputs.functionAppName }}" \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --settings \
              ALLOWED_EMAILS="awwsawws@gmail.com,awwsawws@hotmail.com" \
              DRY_RUN="true" \
              ADMIN_USERNAME="azureuser" \
              AZURE_SUBSCRIPTION_ID="$SUBSCRIPTION_ID" \
              AZURE_RESOURCE_GROUP="${{ env.RESOURCE_GROUP }}"

      - name: Build and Deploy Static Web App
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ steps.swa-token.outputs.token }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: 'upload'
          app_location: '/' 
          skip_app_build: true
          output_location: '/'

      - name: Deployment Summary
        run: |
          echo "### Deployment Complete! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Resource Group:** ${{ env.RESOURCE_GROUP }}" >> $GITHUB_STEP_SUMMARY
          echo "**Location:** ${{ env.LOCATION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Function App:** ${{ steps.deploy-infra.outputs.functionAppName }}" >> $GITHUB_STEP_SUMMARY
          echo "**Static Web App:** ${{ steps.deploy-infra.outputs.staticWebAppName }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Verify SWA Backends linking in Azure Portal:" >> $GITHUB_STEP_SUMMARY
          echo "   - Navigate to Static Web App â†’ APIs/Backends blade" >> $GITHUB_STEP_SUMMARY
          echo "   - Link Function App as backend API with path /api" >> $GITHUB_STEP_SUMMARY
          echo "2. Configure authentication providers in SWA (Google/Microsoft)" >> $GITHUB_STEP_SUMMARY
          echo "3. Test deployment with DRY_RUN=true (currently set)" >> $GITHUB_STEP_SUMMARY
          echo "4. When ready, set DRY_RUN=false to enable actual VM provisioning" >> $GITHUB_STEP_SUMMARY
