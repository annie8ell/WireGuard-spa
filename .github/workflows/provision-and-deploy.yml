name: Provision Infrastructure and Deploy Applications

on:
  workflow_dispatch:
    inputs:
      resourceGroupName:
        description: 'Azure Resource Group name'
        required: true
        default: 'wireguard-spa-rg'
      location:
        description: 'Azure region for resources'
        required: true
        default: 'westeurope'
      projectName:
        description: 'Project name prefix (lowercase, no spaces)'
        required: true
        default: 'wgspa'
      customVmImageId:
        description: 'Optional: Custom VM Image Resource ID for baked WireGuard images'
        required: false
        default: ''

env:
  RESOURCE_GROUP: ${{ github.event.inputs.resourceGroupName || 'wireguard-spa-rg' }}
  LOCATION: ${{ github.event.inputs.location || 'westeurope' }}
  PROJECT_NAME: ${{ github.event.inputs.projectName || 'wgspa' }}
  CUSTOM_VM_IMAGE_ID: ${{ github.event.inputs.customVmImageId || '' }}
  PYTHON_VERSION: '3.10'

jobs:
  provision-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Check or Create Resource Group
        id: check-rg
        run: |
          set -euo pipefail
          RG="${{ env.RESOURCE_GROUP }}"
          LOCATION="${{ env.LOCATION }}"

          echo "Checking whether resource group '$RG' exists..."
          EXISTS=$(az group exists --name "$RG" || true)

          if [ "$EXISTS" = "false" ]; then
            echo "Resource group '$RG' does not exist. Creating in location '$LOCATION'..."
            az group create --name "$RG" --location "$LOCATION"
            echo "âœ“ Resource group created successfully."
          else
            CURRENT_LOC=$(az group show --name "$RG" --query location -o tsv || true)
            if [ -z "$CURRENT_LOC" ]; then
              echo "ERROR: Unable to determine existing resource group's location for '$RG'." >&2
              exit 1
            fi

            # Normalize to lowercase for comparison
            if [ "$(echo "$CURRENT_LOC" | tr '[:upper:]' '[:lower:]')" != "$(echo "$LOCATION" | tr '[:upper:]' '[:lower:]')" ]; then
              echo "ERROR: Resource group '$RG' already exists in location '$CURRENT_LOC' but workflow requested '$LOCATION'." >&2
              echo "To continue, either choose the matching location or use a different resource group name." >&2
              exit 1
            fi

            echo "âœ“ Resource group '$RG' exists in the requested location '$LOCATION'. Continuing."
          fi

      - name: Register Required Azure Resource Providers
        run: |
          set -euo pipefail
          echo "=== Registering required Azure resource providers ==="
          
          # Register Microsoft.Insights for Application Insights
          echo "Registering Microsoft.Insights..."
          az provider register --namespace Microsoft.Insights --wait
          
          # Register Microsoft.OperationalInsights for Application Insights workspace dependencies
          echo "Registering Microsoft.OperationalInsights..."
          az provider register --namespace Microsoft.OperationalInsights --wait
          
          # Register Microsoft.Web for Function Apps and Static Web Apps
          echo "Registering Microsoft.Web..."
          az provider register --namespace Microsoft.Web --wait
          
          # Register Microsoft.Storage for Storage Accounts
          echo "Registering Microsoft.Storage..."
          az provider register --namespace Microsoft.Storage --wait
          
          # Register Microsoft.Compute for Virtual Machines (if using custom images)
          echo "Registering Microsoft.Compute..."
          az provider register --namespace Microsoft.Compute --wait
          
          # Register Microsoft.Network for networking resources
          echo "Registering Microsoft.Network..."
          az provider register --namespace Microsoft.Network --wait
          
          echo "âœ“ All required resource providers registered successfully."

      - name: Deploy Bicep Infrastructure
        id: deploy-infra
        run: |
          set -euo pipefail
          
          echo "=== Deploying infrastructure using Bicep ==="
          
          # Prepare deployment parameters
          PARAMS="projectName=${{ env.PROJECT_NAME }} location=${{ env.LOCATION }}"
          
          # Add custom VM image parameter if provided
          if [ -n "${{ env.CUSTOM_VM_IMAGE_ID }}" ]; then
            echo "Using custom VM image: ${{ env.CUSTOM_VM_IMAGE_ID }}"
            PARAMS="$PARAMS customVmImageId=${{ env.CUSTOM_VM_IMAGE_ID }}"
          fi
          
          # Attempt deployment and capture result
          if ! OUTPUT=$(az deployment group create \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --template-file infra/main.bicep \
            --parameters $PARAMS \
            --query 'properties.outputs' -o json 2>&1); then
            
            echo "ERROR: Bicep deployment failed!" >&2
            echo "Error details:" >&2
            echo "$OUTPUT" >&2
            
            echo "" >&2
            echo "Retrieving deployment operation details for diagnostics..." >&2
            
            # Get the most recent deployment name
            DEPLOYMENT_NAME=$(az deployment group list \
              --resource-group "${{ env.RESOURCE_GROUP }}" \
              --query '[0].name' -o tsv 2>/dev/null || echo "main")
            
            echo "Deployment name: $DEPLOYMENT_NAME" >&2
            
            # Show detailed deployment operations
            echo "" >&2
            echo "=== Deployment Operations ===" >&2
            az deployment operation group list \
              --resource-group "${{ env.RESOURCE_GROUP }}" \
              --name "$DEPLOYMENT_NAME" \
              --query '[?properties.provisioningState==`Failed`].[properties.targetResource.resourceType, properties.targetResource.resourceName, properties.statusMessage.error.code, properties.statusMessage.error.message]' \
              -o table 2>&1 || echo "Could not retrieve deployment operations." >&2
            
            exit 1
          fi

          echo "Deployment outputs: $OUTPUT"

          FUNCTION_APP_NAME=$(echo "$OUTPUT" | jq -r '.functionAppName.value // empty')
          SWA_NAME=$(echo "$OUTPUT" | jq -r '.staticWebAppName.value // empty')
          SWA_RESOURCE_ID=$(echo "$OUTPUT" | jq -r '.staticWebAppResourceId.value // empty')

          if [ -z "$FUNCTION_APP_NAME" ] || [ -z "$SWA_NAME" ]; then
            echo "ERROR: Expected deployment outputs not found. Check infra/main.bicep outputs." >&2
            exit 1
          fi

          echo "functionAppName=$FUNCTION_APP_NAME" >> $GITHUB_OUTPUT
          echo "staticWebAppName=$SWA_NAME" >> $GITHUB_OUTPUT
          echo "staticWebAppResourceId=$SWA_RESOURCE_ID" >> $GITHUB_OUTPUT
          
          echo "âœ“ Infrastructure deployed successfully."

      - name: Remove WEBSITE_RUN_FROM_PACKAGE if present
        run: |
          set -euo pipefail
          FUNCTION_APP_NAME="${{ steps.deploy-infra.outputs.functionAppName }}"
          
          echo "=== Checking WEBSITE_RUN_FROM_PACKAGE setting ==="
          
          # Query the current value
          CURRENT_VALUE=$(az functionapp config appsettings list \
            --name "$FUNCTION_APP_NAME" \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --query "[?name=='WEBSITE_RUN_FROM_PACKAGE'].value" -o tsv 2>/dev/null || echo "")
          
          if [ -z "$CURRENT_VALUE" ]; then
            echo "âœ“ WEBSITE_RUN_FROM_PACKAGE is not set. Ready for Kudu deployment."
          else
            echo "âš  WEBSITE_RUN_FROM_PACKAGE is set to: $CURRENT_VALUE"
            
            if [[ "$CURRENT_VALUE" =~ ^https?:// ]]; then
              echo "Removing conflicting setting for Kudu deployment..."
              az functionapp config appsettings delete \
                --name "$FUNCTION_APP_NAME" \
                --resource-group "${{ env.RESOURCE_GROUP }}" \
                --setting-names WEBSITE_RUN_FROM_PACKAGE
              
              az functionapp restart \
                --name "$FUNCTION_APP_NAME" \
                --resource-group "${{ env.RESOURCE_GROUP }}"
              
              echo "âœ“ Setting removed and Function App restarted."
              sleep 30
            fi
          fi

      - name: Retrieve Function App Publish Profile
        id: get-publish-profile
        run: |
          set -euo pipefail
          FUNCTION_APP_NAME="${{ steps.deploy-infra.outputs.functionAppName }}"
          
          echo "Retrieving publish profile..."
          PUBLISH_PROFILE=$(az functionapp deployment list-publishing-profiles \
            --name "$FUNCTION_APP_NAME" \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --xml)
          
          echo "::add-mask::$PUBLISH_PROFILE"
          echo "publishProfile<<EOF" >> $GITHUB_OUTPUT
          echo "$PUBLISH_PROFILE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Retrieve SWA Deployment Token
        id: swa-token
        run: |
          set -euo pipefail
          SWA_NAME="${{ steps.deploy-infra.outputs.staticWebAppName }}"
          
          echo "Retrieving Static Web App deployment token..."
          SWA_TOKEN=$(az staticwebapp secrets list \
            --name "$SWA_NAME" \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --query 'properties.apiKey' -o tsv)
          
          echo "::add-mask::$SWA_TOKEN"
          echo "token=$SWA_TOKEN" >> $GITHUB_OUTPUT

      - name: Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Backend Dependencies
        run: |
          cd backend
          python -m pip install --upgrade pip
          pip install -r requirements.txt --target=".python_packages/lib/site-packages"

      - name: Deploy Backend to Azure Functions
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ steps.deploy-infra.outputs.functionAppName }}
          package: backend
          publish-profile: ${{ steps.get-publish-profile.outputs.publishProfile }}
          scm-do-build-during-deployment: false
          enable-oryx-build: false

      - name: Configure Function App Settings
        run: |
          set -euo pipefail
          SUBSCRIPTION_ID=$(az account show --query id -o tsv)
          FUNCTION_APP_NAME="${{ steps.deploy-infra.outputs.functionAppName }}"
          
          echo "Configuring Function App settings..."
          az functionapp config appsettings set \
            --name "$FUNCTION_APP_NAME" \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --settings \
              ALLOWED_EMAILS="awwsawws@gmail.com,awwsawws@hotmail.com" \
              DRY_RUN="true" \
              ADMIN_USERNAME="azureuser" \
              AZURE_SUBSCRIPTION_ID="$SUBSCRIPTION_ID" \
              AZURE_RESOURCE_GROUP="${{ env.RESOURCE_GROUP }}"

      - name: Deploy Frontend to Static Web App
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ steps.swa-token.outputs.token }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: 'upload'
          app_location: '/'
          output_location: ''
          skip_app_build: true

      - name: Deployment Summary
        run: |
          echo "### ðŸš€ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Resources Created" >> $GITHUB_STEP_SUMMARY
          echo "- **Resource Group:** \`${{ env.RESOURCE_GROUP }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Location:** \`${{ env.LOCATION }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Project Name:** \`${{ env.PROJECT_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Function App:** \`${{ steps.deploy-infra.outputs.functionAppName }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Static Web App:** \`${{ steps.deploy-infra.outputs.staticWebAppName }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Required GitHub Secrets" >> $GITHUB_STEP_SUMMARY
          echo "The following secrets should be configured for automated deployments:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **AZURE_CREDENTIALS** - Service Principal credentials (already configured)" >> $GITHUB_STEP_SUMMARY
          echo "2. **AZURE_FUNCTIONAPP_NAME** - Set to: \`${{ steps.deploy-infra.outputs.functionAppName }}\`" >> $GITHUB_STEP_SUMMARY
          echo "3. **AZURE_FUNCTIONAPP_PUBLISH_PROFILE** - Run:" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "   ./scripts/get-function-publish-profile.sh ${{ steps.deploy-infra.outputs.functionAppName }} ${{ env.RESOURCE_GROUP }} | gh secret set AZURE_FUNCTIONAPP_PUBLISH_PROFILE" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "4. **AZURE_STATIC_WEB_APPS_API_TOKEN** - Run:" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "   ./scripts/get-swa-deploy-token.sh ${{ steps.deploy-infra.outputs.staticWebAppName }} ${{ env.RESOURCE_GROUP }} | gh secret set AZURE_STATIC_WEB_APPS_API_TOKEN" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "5. **AZURE_RESOURCE_GROUP** - Set to: \`${{ env.RESOURCE_GROUP }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Configure GitHub secrets using the commands above" >> $GITHUB_STEP_SUMMARY
          echo "2. Link Function App to Static Web App in Azure Portal:" >> $GITHUB_STEP_SUMMARY
          echo "   - Navigate to Static Web App â†’ Configuration â†’ APIs/Backends" >> $GITHUB_STEP_SUMMARY
          echo "   - Link Function App as backend API with path \`/api\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Configure authentication providers (Google/Microsoft) in Static Web App" >> $GITHUB_STEP_SUMMARY
          echo "4. Test with DRY_RUN=true (currently enabled)" >> $GITHUB_STEP_SUMMARY
          echo "5. Review [ARCHITECTURE_REVIEW.md](../blob/main/ARCHITECTURE_REVIEW.md) for deployment options" >> $GITHUB_STEP_SUMMARY
          echo "6. When ready, set DRY_RUN=false for actual VM provisioning" >> $GITHUB_STEP_SUMMARY
