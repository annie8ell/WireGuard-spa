name: Validate Repository Secrets

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/validate-secrets.yml'

jobs:
  validate-secrets:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Required Secrets
        id: check-secrets
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_SECRET: ${{ secrets.AZURE_SECRET }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          AZURE_STATIC_WEB_APPS_API_TOKEN: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
        run: |
          set +e
          
          echo "Checking required repository secrets..."
          echo ""
          
          PASSED=0
          FAILED=0
          
          declare -a RESULTS
          
          check_secret() {
            local secret_name=$1
            local secret_value=$2
            
            if [[ -n "$secret_value" ]]; then
              echo "✅ $secret_name is set"
              RESULTS+=("PASS|$secret_name|Set")
              ((PASSED++))
              return 0
            else
              echo "❌ $secret_name is NOT set"
              RESULTS+=("FAIL|$secret_name|Not set")
              ((FAILED++))
              return 1
            fi
          }
          
          echo "=== Checking Secrets ==="
          echo ""
          
          check_secret "AZURE_CLIENT_ID" "$AZURE_CLIENT_ID"
          check_secret "AZURE_SECRET" "$AZURE_SECRET"
          check_secret "AZURE_TENANT_ID" "$AZURE_TENANT_ID"
          check_secret "AZURE_SUBSCRIPTION_ID" "$AZURE_SUBSCRIPTION_ID"
          check_secret "AZURE_STATIC_WEB_APPS_API_TOKEN" "$AZURE_STATIC_WEB_APPS_API_TOKEN"
          
          echo ""
          echo "=== Summary ==="
          echo "Passed: $PASSED"
          echo "Failed: $FAILED"
          echo ""
          
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          
          {
            echo 'results<<EOF'
            printf '%s\n' "${RESULTS[@]}"
            echo EOF
          } >> $GITHUB_OUTPUT
          
          if [[ $FAILED -gt 0 ]]; then
            echo "❌ Validation FAILED: $FAILED secret(s) are missing"
            exit 1
          else
            echo "✅ Validation PASSED: All required secrets are set"
            exit 0
          fi

      - name: Generate Summary Report
        if: always()
        run: |
          echo "# Repository Secrets Validation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          PASSED="${{ steps.check-secrets.outputs.passed }}"
          FAILED="${{ steps.check-secrets.outputs.failed }}"
          
          if [[ "$FAILED" -gt 0 ]]; then
            echo "## ❌ Validation Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "$FAILED secret(s) are missing and need to be configured." >> $GITHUB_STEP_SUMMARY
          else
            echo "## ✅ Validation Passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All required secrets are properly configured." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Name | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          
          while IFS='|' read -r status name description; do
            if [[ "$status" == "PASS" ]]; then
              echo "| $name | ✅ $description |" >> $GITHUB_STEP_SUMMARY
            elif [[ "$status" == "FAIL" ]]; then
              echo "| $name | ❌ $description |" >> $GITHUB_STEP_SUMMARY
            fi
          done <<< "${{ steps.check-secrets.outputs.results }}"
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Required Secrets" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Configure these secrets in your repository:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **AZURE_CLIENT_ID** - Service Principal application ID" >> $GITHUB_STEP_SUMMARY
          echo "2. **AZURE_SECRET** - Service Principal password" >> $GITHUB_STEP_SUMMARY
          echo "3. **AZURE_TENANT_ID** - Azure AD tenant ID" >> $GITHUB_STEP_SUMMARY
          echo "4. **AZURE_SUBSCRIPTION_ID** - Azure subscription ID" >> $GITHUB_STEP_SUMMARY
          echo "5. **AZURE_STATIC_WEB_APPS_API_TOKEN** - SWA deployment token (optional, created by deploy workflow)" >> $GITHUB_STEP_SUMMARY

      - name: Fail Job if Secrets Missing
        if: steps.check-secrets.outputs.failed > 0
        run: |
          echo "❌ Validation failed: ${{ steps.check-secrets.outputs.failed }} secret(s) are missing"
          echo "Please configure the missing secrets and re-run this workflow."
          exit 1
