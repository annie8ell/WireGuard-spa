#cloud-config

# Set hostname
hostname: wireguard-vpn

# Create WireGuard setup script
write_files:
  - path: /usr/local/bin/setup-wireguard.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -e

      # Wait for network to be ready
      while ! ping -c 1 8.8.8.8 &>/dev/null; do
        echo "Waiting for network..."
        sleep 5
      done

      # Get public IP
      PUBLIC_IP=$(curl -s https://api.ipify.org)

      # Generate WireGuard keys
      PRIVATE_KEY=$(wg genkey)
      PUBLIC_KEY=$(echo "$PRIVATE_KEY" | wg pubkey)

      # Create WireGuard config
      cat > /etc/wireguard/wg0.conf << EOF
      [Interface]
      PrivateKey = $PRIVATE_KEY
      Address = 10.0.0.1/24
      ListenPort = 51820
      PostUp = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
      PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE

      # Client configuration will be added here
      EOF

      # Start WireGuard
      systemctl enable wg-quick@wg0
      systemctl start wg-quick@wg0

      # Enable IP forwarding
      echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
      sysctl -p

      # Create client config template
      cat > /root/client.conf << EOF
      [Interface]
      PrivateKey = CLIENT_PRIVATE_KEY
      Address = 10.0.0.2/24

      [Peer]
      PublicKey = $PUBLIC_KEY
      Endpoint = $PUBLIC_IP:51820
      AllowedIPs = 0.0.0.0/0
      EOF

      echo "WireGuard setup complete. Client config saved to /root/client.conf"

# Install required packages
packages:
  - wireguard-tools
  - iptables
  - curl

# Run WireGuard setup
runcmd:
  - /usr/local/bin/setup-wireguard.sh

# Enable services
runcmd:
  - systemctl enable systemd-networkd
  - systemctl start systemd-networkd