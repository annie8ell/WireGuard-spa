variant: fcos
version: 1.4.0
systemd:
  units:
    - name: wireguard-setup.service
      enabled: true
      contents: |
        [Unit]
        Description=WireGuard VPN Setup
        After=network-online.target
        Wants=network-online.target

        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStart=/usr/local/bin/setup-wireguard.sh
        StandardOutput=journal
        StandardError=journal

        [Install]
        WantedBy=multi-user.target
storage:
  files:
    - path: /usr/local/bin/setup-wireguard.sh
      mode: 0755
      contents:
        inline: |
          #!/bin/bash
          set -e

          echo "Starting WireGuard setup..."

          # Wait for network to be fully up
          timeout=60
          while [ $timeout -gt 0 ]; do
            if ip route get 8.8.8.8 >/dev/null 2>&1; then
              break
            fi
            echo "Waiting for network connectivity..."
            sleep 2
            timeout=$((timeout - 2))
          done

          if [ $timeout -le 0 ]; then
            echo "Network timeout reached, exiting"
            exit 1
          fi

          # Get the public IP address
          PUBLIC_IP=$(curl -s --max-time 10 http://checkip.amazonaws.com 2>/dev/null || curl -s --max-time 10 http://ipecho.net/plain 2>/dev/null || curl -s --max-time 10 http://ifconfig.me 2>/dev/null)

          if [ -z "$PUBLIC_IP" ]; then
            echo "Could not determine public IP, exiting"
            exit 1
          fi

          echo "Public IP detected: $PUBLIC_IP"

          # Create WireGuard config directory
          mkdir -p /etc/wireguard

          # Generate server private key
          SERVER_PRIVATE_KEY=$(wg genkey)
          SERVER_PUBLIC_KEY=$(echo "$SERVER_PRIVATE_KEY" | wg pubkey)

          # Generate client keys
          CLIENT_PRIVATE_KEY=$(wg genkey)
          CLIENT_PUBLIC_KEY=$(echo "$CLIENT_PRIVATE_KEY" | wg pubkey)

          # Create server config
          cat > /etc/wireguard/wg0.conf << EOF
          [Interface]
          PrivateKey = $SERVER_PRIVATE_KEY
          Address = 10.13.13.1/24
          ListenPort = 51820
          PostUp = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
          PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE

          [Peer]
          PublicKey = $CLIENT_PUBLIC_KEY
          AllowedIPs = 10.13.13.2/32
          EOF

          # Create client config
          cat > /etc/wireguard/client.conf << EOF
          [Interface]
          PrivateKey = $CLIENT_PRIVATE_KEY
          Address = 10.13.13.2/24
          DNS = 1.1.1.1

          [Peer]
          PublicKey = $SERVER_PUBLIC_KEY
          Endpoint = $PUBLIC_IP:51820
          AllowedIPs = 0.0.0.0/0, ::/0
          PersistentKeepalive = 25
          EOF

          # Start WireGuard
          wg-quick up wg0

          # Enable IP forwarding
          echo 1 > /proc/sys/net/ipv4/ip_forward

          echo "WireGuard setup completed successfully"

          # Output the client config with markers for retrieval
          echo "=== WIREGUARD_CLIENT_CONFIG_START ==="
          cat /etc/wireguard/client.conf
          echo "=== WIREGUARD_CLIENT_CONFIG_END ==="