<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WireGuard On-Demand Launcher</title>
    <!-- Foundation CSS via CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/foundation-sites@6.8.1/dist/css/foundation.min.css">
    <!-- Alpine.js via CDN -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <style>
        body {
            background-color: #f4f4f4;
        }
        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-message {
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }
        .status-loading {
            background-color: #e7f3ff;
            border: 1px solid #2199e8;
        }
        .status-success {
            background-color: #e1faea;
            border: 1px solid #3adb76;
        }
        .status-error {
            background-color: #ffe6e6;
            border: 1px solid #cc4b37;
        }
        .user-info {
            background-color: #f0f0f0;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        pre {
            background-color: #f5f5f5;
            padding: 1rem;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container" x-data="vpnLauncher()">
        <h1>WireGuard On-Demand Launcher</h1>
        
        <!-- Loading State -->
        <div x-show="loading && !user" class="status-message status-loading">
            <p>Loading user information...</p>
        </div>

        <!-- Unauthorized Access -->
        <div x-show="!loading && !user" class="status-message status-error">
            <h3>Access Denied</h3>
            <p>You are not authorized to use this service. Please sign in with an authorized account.</p>
            <a href="/.auth/login/google" class="button primary">Sign in with Google</a>
            <a href="/.auth/login/aad" class="button primary">Sign in with Microsoft</a>
        </div>

        <!-- Authorized User Interface -->
        <div x-show="user">
            <div class="user-info">
                <strong>Signed in as:</strong> <span x-text="user?.userDetails || 'Unknown'"></span>
                <a href="/.auth/logout" class="button small secondary float-right">Sign Out</a>
                <div class="clearfix"></div>
            </div>

            <!-- Request VPN Section -->
            <div x-show="!orchestrationId && !error">
                <h3>Request a WireGuard VPN</h3>
                <p>Click the button below to provision your on-demand WireGuard VPN. The VM will automatically tear down after 30 minutes.</p>
                <button 
                    @click="requestVPN()" 
                    :disabled="requesting"
                    class="button large primary"
                    x-text="requesting ? 'Requesting...' : 'Request VPN'">
                </button>
            </div>

            <!-- Status Polling -->
            <div x-show="orchestrationId && status !== 'Completed'" class="status-message status-loading">
                <h4>Provisioning VPN...</h4>
                <p>Status: <strong x-text="status"></strong></p>
                <p x-show="statusMessage" x-text="statusMessage"></p>
                <p><small>This may take a few minutes. Please wait...</small></p>
            </div>

            <!-- Success - Config Ready -->
            <div x-show="status === 'Completed' && configText" class="status-message status-success">
                <h4>âœ“ VPN Ready!</h4>
                <p>Your WireGuard configuration is ready. Download it and import into your WireGuard client.</p>
                <button @click="downloadConfig()" class="button success large">
                    Download wireguard.conf
                </button>
                <details style="margin-top: 1rem;">
                    <summary>Show Configuration</summary>
                    <pre x-text="configText"></pre>
                </details>
                <p style="margin-top: 1rem;"><small><strong>Note:</strong> This VM will automatically shut down in 30 minutes.</small></p>
            </div>

            <!-- Error State -->
            <div x-show="error" class="status-message status-error">
                <h4>Error</h4>
                <p x-text="error"></p>
                <button @click="reset()" class="button alert">Try Again</button>
            </div>
        </div>
    </div>

    <script>
        function vpnLauncher() {
            return {
                loading: true,
                user: null,
                requesting: false,
                orchestrationId: null,
                status: null,
                statusMessage: null,
                configText: null,
                error: null,
                pollInterval: null,
                allowlist: ['annie8ell@gmail.com'], // Seed allowlist

                async init() {
                    await this.checkAuth();
                },

                async checkAuth() {
                    try {
                        const response = await fetch('/.auth/me');
                        const data = await response.json();
                        
                        if (data.clientPrincipal) {
                            const email = data.clientPrincipal.userDetails;
                            // Check allowlist
                            if (this.allowlist.includes(email)) {
                                this.user = data.clientPrincipal;
                            } else {
                                console.warn('User not in allowlist:', email);
                                this.user = null;
                            }
                        }
                    } catch (err) {
                        console.error('Auth check failed:', err);
                        this.user = null;
                    } finally {
                        this.loading = false;
                    }
                },

                async requestVPN() {
                    this.requesting = true;
                    this.error = null;
                    
                    try {
                        const response = await fetch('/api/http_start', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ action: 'provision' })
                        });

                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            throw new Error(errorData.error || `Request failed: ${response.status}`);
                        }

                        const data = await response.json();
                        this.orchestrationId = data.id;
                        this.status = 'Running';
                        
                        // Start polling for status
                        this.startPolling();
                    } catch (err) {
                        console.error('Request VPN failed:', err);
                        this.error = err.message || 'Failed to start VPN provisioning. Please try again.';
                    } finally {
                        this.requesting = false;
                    }
                },

                startPolling() {
                    if (this.pollInterval) {
                        clearInterval(this.pollInterval);
                    }
                    
                    this.pollInterval = setInterval(() => {
                        this.checkStatus();
                    }, 3000); // Poll every 3 seconds
                    
                    // Initial check
                    this.checkStatus();
                },

                async checkStatus() {
                    if (!this.orchestrationId) return;
                    
                    try {
                        const response = await fetch(`/api/status_proxy/${this.orchestrationId}`);
                        
                        if (!response.ok) {
                            throw new Error(`Status check failed: ${response.status}`);
                        }

                        const data = await response.json();
                        this.status = data.runtimeStatus;
                        
                        if (data.runtimeStatus === 'Completed') {
                            clearInterval(this.pollInterval);
                            
                            if (data.output && data.output.confText) {
                                this.configText = data.output.confText;
                            } else if (data.output && data.output.status === 'ready') {
                                this.configText = data.output.confText;
                            } else {
                                this.error = 'Configuration not available in response';
                            }
                        } else if (data.runtimeStatus === 'Failed') {
                            clearInterval(this.pollInterval);
                            this.error = 'VPN provisioning failed. Please try again.';
                        }
                        
                        // Update status message if available
                        if (data.customStatus) {
                            this.statusMessage = data.customStatus;
                        }
                    } catch (err) {
                        console.error('Status check failed:', err);
                        // Don't stop polling on temporary errors
                    }
                },

                downloadConfig() {
                    if (!this.configText) return;
                    
                    // Create a Blob and download
                    const blob = new Blob([this.configText], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'wireguard.conf';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                },

                reset() {
                    this.orchestrationId = null;
                    this.status = null;
                    this.statusMessage = null;
                    this.configText = null;
                    this.error = null;
                    if (this.pollInterval) {
                        clearInterval(this.pollInterval);
                    }
                }
            };
        }
    </script>
</body>
</html>
